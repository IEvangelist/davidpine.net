<!DOCTYPE HTML>

<html>

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <link rel="icon" href="/img/main/favicon.png" type="image/png" />
    <link rel="shortcut icon" href="/favicon.ico" />
    
    
    <title>ASP.NET Core Response Optimization</title>
    
    

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Hugo 0.129.0">
    


    
    <meta name="author" content="David Pine">
    
    
    <meta name="description" content="Static File Caching &amp; Compression">
    

    
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/img/2016/12/speedy.jpg">
  <meta name="twitter:title" content="ASP.NET Core Response Optimization">
  <meta name="twitter:description" content="Static File Caching &amp; Compression">

    <meta property="og:url" content="http://localhost:1313/blog/asp-net-core-optimization/">
  <meta property="og:site_name" content="David Pine">
  <meta property="og:title" content="ASP.NET Core Response Optimization">
  <meta property="og:description" content="Static File Caching &amp; Compression">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2016-12-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2016-12-12T00:00:00+00:00">
    <meta property="og:image" content="http://localhost:1313/img/2016/12/speedy.jpg">

    
  <meta itemprop="name" content="ASP.NET Core Response Optimization">
  <meta itemprop="description" content="Static File Caching &amp; Compression">
  <meta itemprop="datePublished" content="2016-12-12T00:00:00+00:00">
  <meta itemprop="dateModified" content="2016-12-12T00:00:00+00:00">
  <meta itemprop="wordCount" content="1168">
  <meta itemprop="image" content="http://localhost:1313/img/2016/12/speedy.jpg">
  <meta itemprop="keywords" content="ASP.NET Core,GZip,Compression,Caching">

    

    
    
    
    

    
    
    
    <link rel="stylesheet" href=/css/add-on.min.css />
    <link rel="stylesheet" href="/css/font-awesome.min.css" />
    
    <link rel="stylesheet" href=/css/github-dark.min.css />
    
    <link rel="stylesheet" href=/css/google-font.min.css />
    
    <link rel="stylesheet" href=/css/main.min.css />
    

    

    
    
    
</head>

<body>
    <a rel="me" href="https://dotnet.social/@davidpine"></a>
    <script src="/js/jquery.min.js?1.7.1"></script>

    
    <div id="wrapper">
    
    
<header id="header">
    
        <h2><a href="http://localhost:1313/">IEvangelist</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/blog">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        
                            <i class="fa fa-list-ol">&nbsp;</i>Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        
                            <i class="fa fa-smile-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/speaking">
                        
                            <i class="fa fa-bullhorn">&nbsp;</i>Speaking
                    </a>
                </li>
            
                <li>
                    <a href="/media">
                        
                            <i class="fa fa-video-camera">&nbsp;</i>Media
                    </a>
                </li>
            
                <li>
                    <a href="/pictures">
                        
                            <i class="fa fa-camera">&nbsp;</i>Pictures
                    </a>
                </li>
            
                <li>
                    <a href="/conclusions">
                        
                            <i class="fa fa-lightbulb-o">&nbsp;</i>Conclusions
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://localhost:1313/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://localhost:1313/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/blog">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                    <i class="fa fa-list-ol">&nbsp;</i>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                    <i class="fa fa-smile-o">&nbsp;</i>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/speaking">
                            <h3>
                                
                                    <i class="fa fa-bullhorn">&nbsp;</i>
                                
                                Speaking
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/media">
                            <h3>
                                
                                    <i class="fa fa-video-camera">&nbsp;</i>
                                
                                Media
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/pictures">
                            <h3>
                                
                                    <i class="fa fa-camera">&nbsp;</i>
                                
                                Pictures
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/conclusions">
                            <h3>
                                
                                    <i class="fa fa-lightbulb-o">&nbsp;</i>
                                
                                Conclusions
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://localhost:1313/blog/dotnet-async-enumerable/"><p>Exploring .NET streaming API scenarios</p></a>
                    </li>
                
                    <li>
                        <a href="http://localhost:1313/blog/dotnet-dependency-injection/"><p>A conversation with ChatGPT </p></a>
                    </li>
                
                    <li>
                        <a href="http://localhost:1313/blog/github-actions-sdk/"><p>Hello from the GitHub Actions: Core .NET SDK</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//github.com/sponsors/IEvangelist?o=esb" target="_blank" class="share-btn github" title="Sponsor IEvangelist on GitHub?">
    <i class="fa fa-heart-o"></i>
    <p>Sponsor</p>
</a></li>


<li><a href="//twitter.com/share?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&text=ASP.NET%20Core%20Response%20Optimization&via=davidpine7" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&title=ASP.NET%20Core%20Response%20Optimization" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&title=ASP.NET%20Core%20Response%20Optimization" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&title=ASP.NET%20Core%20Response%20Optimization" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by David%20Pine&body=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="http://localhost:1313/blog/asp-net-core-optimization/">ASP.NET Core Response Optimization</a></h1>
            
        
        
            <p>Static File Caching &amp; Compression</p>
        
    </div>
    <div class="meta">
        
            
        

        
        
        
        
        
        

        
        
        

        <div style="display: none;"
            data-date='2025'
            data-lastmod='2016'
            data-min='2016'
            data-max='2025'
            data-difference='9'
            data-var='6'>
        </div>

        
        <time class="published" data-hover='2016'
            datetime='2016'
            data-initial='Written in' data-extras='9'>
            <span class="underline">(<i class="fa fa-mouse-pointer"></i>?</span>)
        </time>
        

        <span class="author">David Pine</span>
        
            <p>6 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//github.com/sponsors/IEvangelist?o=esb" target="_blank" class="share-btn github" title="Sponsor IEvangelist on GitHub?">
    <i class="fa fa-heart-o"></i>
    <p>Sponsor</p>
</a></li>


<li><a href="//twitter.com/share?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&text=ASP.NET%20Core%20Response%20Optimization&via=davidpine7" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&title=ASP.NET%20Core%20Response%20Optimization" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&title=ASP.NET%20Core%20Response%20Optimization" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f&title=ASP.NET%20Core%20Response%20Optimization" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by David%20Pine&body=http%3a%2f%2flocalhost%3a1313%2fblog%2fasp-net-core-optimization%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    
    

    
        
        




    


        

        <a href="http://localhost:1313/blog/asp-net-core-optimization/" class="image featured">
            <img src="/img/2016/12/speedy.jpg" alt="" />
        </a>
    


    <div id="content">
        <h2 id="intro">Intro</h2>
<p>If you&rsquo;re a web developer, chances are you&rsquo;re familiar with optimization strategies such as static file caching and response compression. I recently implemented these two concepts in
tandem on an <strong>ASP.NET Core</strong> application that I have been developing&hellip; I&rsquo;m going to share what I have learned.</p>
<p>If you haven&rsquo;t had a chance to use <a href="https://www.asp.net/core"><code>ASP.NET Core</code></a> yet, you&rsquo;re missing out! As my friend <a href="https://scottaddie.com/">Scott Addie</a> likes to say:</p>
<blockquote>
<p><strong>ASP.NET Core</strong> is a cafeteria plan in which developers choose application dependencies <em>à la carte</em>. This is in stark contrast to <strong>ASP.NET</strong> proper, where developers
are provided a set meal (a bloated dependency chain) containing undesired items. Don&rsquo;t like broccoli with your steak? Maybe it&rsquo;s time to consider <strong>ASP.NET Core</strong>.
<!-- raw HTML omitted -->Scott Addie<!-- raw HTML omitted --></p>
</blockquote>
<p>In other words, all dependencies are pluggable middleware. This provides ultimate control as you have to explicitly <em>opt-in</em> for the middleware you desire.</p>
<h3 id="know-thy-middleware">Know thy Middleware</h3>
<p>Not all middleware is equal. Different middleware serves different purposes (obviously). Try to think of each middleware as its own standalone feature-set. Not all middleware is
given a chance to execute on a given request. Certain middleware might send a web response and early exit. This can prevent other middleware in the pipeline from executing at all. In
fact, this is the case when using static file caching and response compression together.</p>
<blockquote>
<p>The <em>order</em> in which middleware is added matters and dictates the order of execution during a request.</p>
</blockquote>
<h4 id="installing-dependencies">Installing Dependencies</h4>
<p>I wrote a tiny application and put it up on GitHub, check it out 

    
        
    

    <a href="https://github.com/IEvangelist/IEvangelist.AspNetCore.Optimization" target='_blank'>here</a>

 if you want to follow along. Now let&rsquo;s install the dependencies we&rsquo;ll need. For static file caching and response compression we need to add two <code>dependencies</code> to the project.</p>
<p><em>Note:</em> <code>Microsoft.AspNetCore.StaticFiles</code> will already have been installed if you started from a <strong>Visual Studio</strong> template.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Repository</th>
<th style="text-align:left">Version</th>
<th style="text-align:left">Nuget Package</th>
<th style="text-align:left">Add / Use Extension Method(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/aspnet/StaticFiles"><i class="fa fa-github-alt" aria-hidden="true"></i></a></td>
<td style="text-align:left"><code>1.1.0</code></td>
<td style="text-align:left">

    
        
    

    <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.StaticFiles/" target='_blank'>Static Files</a>

</td>
<td style="text-align:left">

    
        
    

    <a href="https://github.com/aspnet/StaticFiles/blob/dev/src/Microsoft.AspNetCore.StaticFiles/StaticFileExtensions.cs#L56-L68" target='_blank'>UseStaticFiles</a>

</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/aspnet/BasicMiddleware"><i class="fa fa-github-alt" aria-hidden="true"></i></a></td>
<td style="text-align:left"><code>1.0.0</code></td>
<td style="text-align:left">

    
        
    

    <a href="https://www.nuget.org/packages/Microsoft.AspNetCore.ResponseCompression/" target='_blank'>Response Compression</a>

</td>
<td style="text-align:left">

    
        
    

    <a href="https://github.com/aspnet/BasicMiddleware/blob/dev/src/Microsoft.AspNetCore.ResponseCompression/ResponseCompressionServicesExtensions.cs#L38-L53" target='_blank'>AddResponseCompression</a>

 
 
     
         
     
 
     <a href="https://github.com/aspnet/BasicMiddleware/blob/dev/src/Microsoft.AspNetCore.ResponseCompression/ResponseCompressionBuilderExtensions.cs#L20-L29" target='_blank'>UseResponseCompression</a>
 
</td>
</tr>
</tbody>
</table>
<p>Follow these instructions, from within <strong>Visual Studio</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">Tools ➪</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">NuGet Package Manager ➪</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">Manage NuGet Packages for Solution... ➪ </span>
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">Browse ➪</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ae81ff">Search ➪</span>
</span></span><span style="display:flex;"><span>                    [ <span style="color:#ae81ff">Install ]</span>
</span></span></code></pre></div><h3 id="configuring-startup">Configuring Startup</h3>
<p>There are two common nomenclatures that exist for wiring up middleware in your startup classes, the <code>.Add*</code> and <code>.Use*</code> extension methods. The <code>.Add*</code> calls are intended to add
services to the <code>IServiceCollection</code> instance, ensuring that they are ready for <em>usage</em>. The <code>.Use*</code> calls specify that you want to use the middleware and makes the assumption
that any services required by <strong>DI</strong> will have already been <em>added</em> with the corresponding <code>.Add*</code> call.</p>
<p>Now let&rsquo;s &ldquo;add&rdquo; response compression in the <code>.ConfigureServices</code> call of our <code>Startup.cs</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> ConfigureServices(IServiceCollection services)
</span></span><span style="display:flex;"><span>{    
</span></span><span style="display:flex;"><span>    services.AddMvc();
</span></span><span style="display:flex;"><span>    services.AddResponseCompression(
</span></span><span style="display:flex;"><span>        options =&gt; 
</span></span><span style="display:flex;"><span>            options.MimeTypes = ResponseCompressionMimeTypes.Defaults);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Several bits of the implementation details should jump out at you. First, we do not need to call an <code>.AddStaticFiles</code> extension method because there are no services required
for this middleware, as such it doesn&rsquo;t exist. Second, we are providing a lambda expression to satisfy the <code>Action&lt;ResponseCompressionOptions&gt;</code> parameter. We also assign the
<code>.MimeTypes</code> property from the <code>ResponseCompressionMimeTypes.Defaults</code> we are targeting for compression.</p>
<blockquote>
<p>If no compression providers are specified then <code>GZip</code> is used by default.
<!-- raw HTML omitted -->

    
        
    

    <a href="https://github.com/aspnet/BasicMiddleware/blob/dev/src/Microsoft.AspNetCore.ResponseCompression/ResponseCompressionProvider.cs#L22" target='_blank'>ASP.NET Core Team - GitHub</a>

<!-- raw HTML omitted --></p>
</blockquote>
<p>The <code>ResponseCompressionMimeTypes.cs</code> is defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Collections.Generic;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Linq;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> static Microsoft.AspNetCore.ResponseCompression.ResponseCompressionDefaults;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> IEvangelist.AspNetCore.Optimization
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResponseCompressionMimeTypes</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> IEnumerable&lt;<span style="color:#66d9ef">string</span>&gt; Defaults
</span></span><span style="display:flex;"><span>            =&gt; MimeTypes.Concat(<span style="color:#66d9ef">new</span>[]
</span></span><span style="display:flex;"><span>                                {
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;image/svg+xml&#34;</span>,
</span></span><span style="display:flex;"><span>                                    <span style="color:#e6db74">&#34;application/font-woff2&#34;</span>
</span></span><span style="display:flex;"><span>                                });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There are several types defined by default in <strong>ASP.NET Core</strong> class <code>ResponseCompressionDefaults.MimeTypes</code>, we are simply expanding that to include &ldquo;SVG&rdquo; images and the &ldquo;Woff2&rdquo; fonts.</p>
<h3 id="order-exemplified">Order Exemplified</h3>
<p>Consider the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Configure(IApplicationBuilder app,
</span></span><span style="display:flex;"><span>                      IHostingEnvironment env,
</span></span><span style="display:flex;"><span>                      ILoggerFactory loggerFactory)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    app.UseStaticFiles()          <span style="color:#75715e">// Adds the static middleware to the request pipeline</span>
</span></span><span style="display:flex;"><span>       .UseResponseCompression(); <span style="color:#75715e">// Adds the response compression to the request pipeline</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The snippet above will absolutely work for serving static files, but it will not compress or cache anything. Note the differences below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Configure(IApplicationBuilder app,
</span></span><span style="display:flex;"><span>                      IHostingEnvironment env,
</span></span><span style="display:flex;"><span>                      ILoggerFactory loggerFactory)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    app.UseResponseCompression()  <span style="color:#75715e">// Adds the response compression to the request pipeline</span>
</span></span><span style="display:flex;"><span>       .UseStaticFiles();         <span style="color:#75715e">// Adds the static middleware to the request pipeline       </span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The <em>order</em> in which the middleware was invoked in the pipeline changed, as such the order in which the middleware is executed on a request is also changed.
When static file middleware occurs before response compression, it returns the file as a response before compression has a chance to execute.</p>
<ul>
<li>Client requests <code>main.css</code></li>
<li>Static file middleware determines it can fully satisfy said request</li>
<li>The <code>main.css</code> file is 

    
        
    

    <a href="https://github.com/aspnet/StaticFiles/blob/dev/src/Microsoft.AspNetCore.StaticFiles/StaticFileMiddleware.cs#L109" target='_blank'>sent</a>

 and the 

 middleware in the pipeline is never executed</li>
</ul>
<p>Now that we have these two pieces of middleware wired into out pipeline in the correct order, what else is left. There is one important thing that we forgot to do.
While we do have static file middleware, we didn&rsquo;t know that &ldquo;caching&rdquo; is off by default. So we&rsquo;ll need to handle this with an instance of the the <code>StaticFileOptions</code>.</p>
<blockquote>
<p>Keep your <i class="fa fa-eye" aria-hidden="true"></i><i class="fa fa-eye" aria-hidden="true"></i>&rsquo;s open for extension method overloads. These are often clues that there are <em>options</em> for providing customized configuration for the middleware you&rsquo;re wiring up.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Configure(IApplicationBuilder app,
</span></span><span style="display:flex;"><span>                      IHostingEnvironment env,
</span></span><span style="display:flex;"><span>                      ILoggerFactory loggerFactory)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    app.UseResponseCompression()
</span></span><span style="display:flex;"><span>       .UseStaticFiles(
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">new</span> StaticFileOptions
</span></span><span style="display:flex;"><span>           {
</span></span><span style="display:flex;"><span>               OnPrepareResponse =
</span></span><span style="display:flex;"><span>                   _ =&gt; _.Context.Response.Headers[HeaderNames.CacheControl] = 
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;public,max-age=604800&#34;</span> <span style="color:#75715e">// A week in seconds</span>
</span></span><span style="display:flex;"><span>           })
</span></span><span style="display:flex;"><span>       .UseMvc(routes =&gt; routes.MapRoute(<span style="color:#e6db74">&#34;default&#34;</span>, <span style="color:#e6db74">&#34;{controller=Home}/{action=Index}/{id?}&#34;</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The instance of the <code>StaticFileOptions</code> object has a public property namely &ldquo;OnPrepareResponse&rdquo; of type <code>Action&lt;StaticFileResponseContext&gt;</code>. So we can again specify a lambda
expression. This expression can be used to delegate the preparation of the response. Notice we&rsquo;re simply setting the <code>Cache-Control</code> header to a &ldquo;max-age&rdquo; of a week. That was
pretty simple, hey?!</p>
<h3 id="compression-awareness">Compression Awareness</h3>
<p>It&rsquo;s all the little things! The response compression middleware boasts deterministic compression, i.e.; if the


    
        
    

    <a href="https://github.com/aspnet/KestrelHttpServer" target='_blank'><code>KestrelHttpServer</code></a>

 is running behind the


    
        
    

    <a href="https://www.iis.net/" target='_blank'><strong>IIS</strong></a>

 reverse proxy then the middleware may or may not compress the response. The middleware determines the following:</p>
<ul>
<li>If the request accepts compression</li>
<li>If the requested resource matches the configured MIME types</li>
<li>Whether or not the response needs to be compressed</li>
</ul>
<h3 id="results">Results</h3>
<p>Let&rsquo;s spend some time examining the results of our response optimization efforts.</p>
<h4 id="before">Before</h4>
<p><img src="/img/2016/12/before.png" alt="Before"></p>
<h5 id="totals">Total(s)</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">13</span> <span style="color:#ae81ff">Requests | 549 KB transferred | ... | ... </span>
</span></span></code></pre></div><p><strong>banner1.svg Response Headers</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">HTTP/1.1 200 OK</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Content-Length</span>: <span style="color:#ae81ff">9679</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Content-Type</span>: <span style="color:#ae81ff">image/svg+xml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Accept-Ranges</span>: <span style="color:#ae81ff">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ETag</span>: <span style="color:#e6db74">&#34;1d1ce31e3bd09cf&#34;</span>
</span></span></code></pre></div><h4 id="after">After</h4>
<p><img src="/img/2016/12/after.png" alt="After"></p>
<h5 id="totals-1">Total(s)</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">13</span> <span style="color:#ae81ff">Requests | 175 KB transferred | ... | ... </span>
</span></span></code></pre></div><p>The total payload for all 13 requests is a total of 3.137 times smaller (a meager 31.9% of the original size). The larger the application, the more dramatic and valuable
this becomes! Consider an <strong>Angular2</strong> application (or other SPA framework based application), which has tons of <strong>JavaScript</strong> files to download &ndash; 5 MB turns into ~1.5 MB.</p>
<p><strong>banner1.svg Response Headers</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#ae81ff">HTTP/1.1 200 OK</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Content-Type</span>: <span style="color:#ae81ff">image/svg+xml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Server</span>: <span style="color:#ae81ff">Kestrel</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Cache-Control</span>: <span style="color:#ae81ff">public,max-age=604800</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Transfer-Encoding</span>: <span style="color:#ae81ff">chunked</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Content-Encoding</span>: <span style="color:#ae81ff">gzip</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">Accept-Ranges</span>: <span style="color:#ae81ff">bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">ETag</span>: <span style="color:#e6db74">&#34;1d1ce31e3bd09cf&#34;</span>
</span></span></code></pre></div><h4 id="subsequent-cached-requests">Subsequent (Cached) Requests</h4>
<p><img src="/img/2016/12/cached.png" alt="Cached"></p>
<h3 id="lets-summarize">Let&rsquo;s Summarize</h3>
<p>We learned some of the basics about <strong>ASP.NET Core</strong> middleware. Together we implemented a response optimization strategy that included deterministic response compression, as well
as static file caching. We learned some of the common patterns and naming conventions for integrating with <strong>ASP.NET Core</strong> middleware. Finally, we have a good understanding of
the <strong>ASP.NET Core</strong> request pipeline middleware precedence.</p>
<h3 id="source-code">Source Code</h3>
<ul>
<li><i class="fa fa-github-square" aria-hidden="true"></i> <a href="https://github.com/IEvangelist/IEvangelist.AspNetCore.Optimization">IEvangelist.AspNetCore.Optimization</a></li>
</ul>

    </div>

    <footer>
        <ul class="stats">
    <li>
        <i class="fa fa-list-ol">&nbsp;</i>
        Categories
    </li>
    
        
        
            
            
            <li><a class="article-category-link" href="http://localhost:1313/categories/asp.net-core">ASP.NET Core</a></li>
            
            
            <li><a class="article-category-link" href="http://localhost:1313/categories/gzip">GZip</a></li>
            
            
            <li><a class="article-category-link" href="http://localhost:1313/categories/compression">Compression</a></li>
            
            
            <li><a class="article-category-link" href="http://localhost:1313/categories/caching">Caching</a></li>
            
        
    
</ul>
    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="http://localhost:1313/blog/imposter-syndrome/"
                class="button big previous">Overcoming Impostor Syndrome</a></li>
    

    
        <li><a href="http://localhost:1313/blog/building-a-magic-mirror/"
                class="button big next">Building a Magic Mirror</a></li>
    
</ul>



    


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
    
    <section class='p-2 justify-content-center'>
      <img src="/img/main/me-1.png" class="intro-circle fade-swap d-flex" width=""
        alt="David Pine" />
      <img src="/img/main/me-2.png" class="intro-circle fade-swap d-flex" width=""
        alt="David Pine" style="display: none;" />
      <img src="/img/main/me-3.png" class="intro-circle fade-swap d-flex" width=""
        alt="David Pine" style="display: none;" />
      <img src="/img/main/me-4.png" class="intro-circle fade-swap d-flex" width=""
        alt="David Pine" style="display: none;" />
      <img src="/img/main/me-5.png" class="intro-circle fade-swap d-flex" width=""
        alt="David Pine" style="display: none;" />
      
      
    </section>
    
    <header>
      <h2>David Pine</h2>
      <p>
        🤓 Changing the world — one line of code at a time.
        <span class="responsive-float">
          <a id='davidpine7' href='https://twitter.com/davidpine7?ref_src=twsrc%5Etfw' class='twitter-follow-button'
            data-size='large' data-show-count='false'>
            Follow @davidpine7
          </a>
        </span>
        <script>
          window.twitter = (function (d, s, id) {
            var js,
              fjs = d.getElementsByTagName(s)[0],
              t = window.twttr || {};
            if (d.getElementById(id)) return t;
            js = d.createElement(s);
            js.id = id;
            js.src = "https://platform.twitter.com/widgets.js";
            fjs.parentNode.insertBefore(js, fjs);

            t._e = [];
            t.ready = function (f) {
              t._e.push(f);
            };

            return t;
          }(document, "script", "twitter-wjs"));
        </script>
      </p>
    </header>
    

    <hr />

    <div class='row'>
      <div class='column'>
        <a target="_blank" rel="noopener nofollow" class='d-flex no-padding justify-content-center'
          href="https://dometrain.com/course/from-zero-to-hero-configuration-and-options-in-dotnet?ref=david-pine">
          <img src="/img/main/dometrain-horizontal-blue-text.png" style="max-width: 75%;" />
        </a>
      </div>
    </div>

    <hr />

    <section class='row justify-content-center'>
      <a href="https://bit.ly/learning-blazor" target="_blank" rel="nofollow noopener"
        class='d-flex no-padding justify-content-center'>
        <img src="/img/main/thumb-book-cover.png" style="max-width: 95%;" />
      </a>
    </section>

    <hr />

    <ul class="icons">
      <li><a href="" type="application/rss+xml"
          target="_blank" title="RSS" class="fa-lg fa-rss"></a>
      </li>
      
      
<li><a href="//github.com/IEvangelist" target="_blank" title="GitHub" class="fa-lg fa-github"></a></li>



<li><a href="//papercall.io/speakers/david-pine" target="_blank" title="PaperCall" class="fa-lg fa-paper-plane-o"></a></li>







<li><a href="//codepen.io/ievangelist" target="_blank" title="CodePen" class="fa-lg fa-codepen"></a></li>















<li><a href="//youtube.com/user/davidpine7" target="_blank" title="YouTube" class="fa-lg fa-youtube"></a></li>







<li><a href="//medium.com/@davidpine7" target="_blank" title="Medium" class="fa-lg fa-medium"></a></li>



<li><a href="//ievangelistblog.wordpress.com" target="_blank" title="WordPress" class="fa-lg fa-wordpress"></a></li>







<li><a href="//linkedin.com/in/dpine" target="_blank" title="LinkedIn" class="fa-lg fa-linkedin"></a></li>





<li><a href="//stackoverflow.com/users/2410379/david-pine" target="_blank" title="Stack Overflow" class="fa-lg fa-stack-overflow"></a></li>



<li><a href="//reddit.com/user/davidpine7" target="_blank" title="Reddit" class="fa-lg fa-reddit"></a></li>









<li><a href="//twitter.com/davidpine7" target="_blank" title="Twitter" class="fa-lg fa-twitter"></a></li>



<li><a href="mailto:david.pine.7@gmail.com" title="Email" class="fa-lg fa-envelope"></a></li>


      
    </ul>
  </section>

  
  <section id="recent-posts">
    <ul class="posts">
      <header>
        <h3>Recent Posts</h3>
      </header>
      
      
      

      
      
      

      
      <li>
        <article>
          <header>
            <h3><a href="http://localhost:1313/blog/dotnet-async-enumerable/">Exploring .NET streaming API scenarios</a></h3>
            
            
            
            <time class="published" datetime='2023-06-19'>
              June 19, 2023</time>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <h3><a href="http://localhost:1313/blog/dotnet-dependency-injection/">A conversation with ChatGPT </a></h3>
            
            
            
            <time class="published" datetime='2022-12-08'>
              December 8, 2022</time>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <h3><a href="http://localhost:1313/blog/github-actions-sdk/">Hello from the GitHub Actions: Core .NET SDK</a></h3>
            
            
            
            <time class="published" datetime='2022-11-30'>
              November 30, 2022</time>
          </header>
        </article>
      </li>
      

      
      <li>
        <ul class="actions">
          <li>
            <a href= /blog/  class="button">
              View more posts
            </a>
          </li>
        </ul>
      </li>
      
    </ul>
  </section>

  
  
  
  
  <section id="categories">
    <ul class="posts">
      <header>
        <h3><a href="/categories/">Categories</a></h3>
      </header>

      
      
      

      
      <li>
        <article>
          <header>
            <a href="/categories/csharp/">csharp</a>
            <span style="float:right;">17</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/asp.net-core/">asp.net core</a>
            <span style="float:right;">10</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/.net-core/">.net core</a>
            <span style="float:right;">8</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/.net/">.net</a>
            <span style="float:right;">7</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/typescript/">typescript</a>
            <span style="float:right;">6</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/angular/">angular</a>
            <span style="float:right;">5</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/rxjs/">rxjs</a>
            <span style="float:right;">4</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/visual-studio/">visual studio</a>
            <span style="float:right;">4</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/wasm/">wasm</a>
            <span style="float:right;">4</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/webassembly/">webassembly</a>
            <span style="float:right;">4</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/blazor/">blazor</a>
            <span style="float:right;">3</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/http/">http</a>
            <span style="float:right;">2</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/json/">json</a>
            <span style="float:right;">2</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/technical-conference/">technical conference</a>
            <span style="float:right;">2</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/tooling/">tooling</a>
            <span style="float:right;">2</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/xunit/">xunit</a>
            <span style="float:right;">2</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/.net-standard/">.net standard</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/azure/">azure</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/azure-functions/">azure functions</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/caching/">caching</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/chatgpt/">chatgpt</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/compression/">compression</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/configuration/">configuration</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/dependency-injection/">dependency injection</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/fear/">fear</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/github/">github</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/gzip/">gzip</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/identity/">identity</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/iot/">iot</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/javascript/">javascript</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/mke-dot-net/">mke dot net</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/openai/">openai</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/raspberry-pi/">raspberry pi</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/roslyn/">roslyn</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/self-branding/">self-branding</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/slack/">slack</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/technical-doubt/">technical doubt</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/twilio/">twilio</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/uwp/">uwp</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
      <li>
        <article>
          <header>
            <a href="/categories/web/">web</a>
            <span style="float:right;">1</span>
          </header>
        </article>
      </li>
      
    </ul>
  </section>
  

  
  

  
  <section id="footer">
    <ul class="icons">
      <li><a href="" type="application/rss+xml"
          target="_blank" title="RSS" class="fa fa-rss"></a>
      </li>
      
      
<li><a href="//github.com/IEvangelist" target="_blank" title="GitHub" class="fa-lg fa-github"></a></li>



<li><a href="//papercall.io/speakers/david-pine" target="_blank" title="PaperCall" class="fa-lg fa-paper-plane-o"></a></li>







<li><a href="//codepen.io/ievangelist" target="_blank" title="CodePen" class="fa-lg fa-codepen"></a></li>















<li><a href="//youtube.com/user/davidpine7" target="_blank" title="YouTube" class="fa-lg fa-youtube"></a></li>







<li><a href="//medium.com/@davidpine7" target="_blank" title="Medium" class="fa-lg fa-medium"></a></li>



<li><a href="//ievangelistblog.wordpress.com" target="_blank" title="WordPress" class="fa-lg fa-wordpress"></a></li>







<li><a href="//linkedin.com/in/dpine" target="_blank" title="LinkedIn" class="fa-lg fa-linkedin"></a></li>





<li><a href="//stackoverflow.com/users/2410379/david-pine" target="_blank" title="Stack Overflow" class="fa-lg fa-stack-overflow"></a></li>



<li><a href="//reddit.com/user/davidpine7" target="_blank" title="Reddit" class="fa-lg fa-reddit"></a></li>









<li><a href="//twitter.com/davidpine7" target="_blank" title="Twitter" class="fa-lg fa-twitter"></a></li>



<li><a href="mailto:david.pine.7@gmail.com" title="Email" class="fa-lg fa-envelope"></a></li>


      
    </ul>

    <p class="copyright">&copy; David Pine 2016-2025. Powered by <a href="//gohugo.io"
        target="_blank">Hugo</a>
    </p>
  </section>

</section>
            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
        
            <script src="/js/skel.min.js?1.7.1"></script>
            
            <script src=/js/util.min.js></script>

            
            <script src=/js/backToTop.min.js></script>
            <script src="/js/highlight.min.js?1.7.1"></script>

            
            
            <script src=/js/main.min.js?1.7.1></script>
        

        

            
            <script>
                document.addEventListener('DOMContentLoaded', (event) => {
                    hljs.highlightAll();
                });
            </script>
            
    </body>
</html>

